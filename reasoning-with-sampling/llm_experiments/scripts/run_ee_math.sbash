#!/bin/bash --login
#SBATCH --job-name=ee_ps_math
#SBATCH --partition=gpunodes
#SBATCH -t 0-23:59
#SBATCH -c 4
#SBATCH --mem=16GB
#SBATCH --gres=gpu:rtx_a4000:1
#SBATCH --array=0-4
#SBATCH --output=ee_ps_math_%a.out
#SBATCH --error=ee_ps_math_%a.err

# --- map array id -> (batch_idx) ---
BATCH_IDX=${SLURM_ARRAY_TASK_ID}
SEED=42

# Ensure module command is available
if [ -f /etc/profile ]; then
    source /etc/profile
fi
# Some systems use a modules.sh file
if [ -f /etc/profile.d/modules.sh ]; then
    source /etc/profile.d/modules.sh
fi

# --- 1. Setup Paths ---
# SCRATCH: For heavy temporary files (Environments, Models)
SCRATCH_ROOT=$(ls -d /scratch/scratch-space/expires-* | head -n 1)

# HOME: For the final result files (Permanent, Safe)
RESULT_DIR="$HOME/results_ee"
mkdir -p "$RESULT_DIR"

# CRITICAL FIX: Switch to the directory where you submitted the job
cd "$SLURM_SUBMIT_DIR" || exit 1

# Get the repository root relative to the submission directory (scripts/)
REPO_ROOT="$(pwd)/../.."
export PYTHONPATH="$PYTHONPATH:$REPO_ROOT/llm_experiments"

echo ">>> CONFIGURATION <<<"
echo "Running in: $(pwd)"
echo "Repository root: $REPO_ROOT"
echo "Temporary Scratch: $SCRATCH_ROOT"
echo "Permanent Results: $RESULT_DIR"
echo "Batch Index: ${BATCH_IDX}"

# --- 2. Environment Setup (In Scratch) ---
ENV_PATH="$SCRATCH_ROOT/$USER/ee_ps_math_env"
MARKER_FILE="$ENV_PATH/READY"

if [ "$BATCH_IDX" -eq 0 ]; then
    echo "Task 0: Managing environment creation..."
    
    # Clean partial install if needed (optional, but safe)
    # rm -rf "$ENV_PATH" 
    
    if [ ! -d "$ENV_PATH" ]; then
        echo "Creating virtual environment in scratch: $ENV_PATH"
        python3 -m venv "$ENV_PATH"
        source "$ENV_PATH/bin/activate"
        pip install --upgrade pip
        
        # INSTALLS: Required packages for the script
        pip install torch transformers pandas tqdm accelerate
        
        # Mark as ready
        touch "$MARKER_FILE"
    else
        echo "Environment exists. checking readiness..."
        # Ensure it's ready if it existed from a previous run
        source "$ENV_PATH/bin/activate"
        if [ ! -f "$MARKER_FILE" ]; then
             # In case it exists but wasn't fully ready (previous crash?)
             pip install torch transformers pandas tqdm accelerate
             touch "$MARKER_FILE"
        fi
    fi
else
    echo "Task ${BATCH_IDX}: Waiting for environment to be ready..."
    while [ ! -f "$MARKER_FILE" ]; do
        sleep 10
    done
    echo "Environment is ready. Activating..."
    source "$ENV_PATH/bin/activate"
fi

# --- 3. Set Model Cache (In Scratch) ---
export HF_HOME="$SCRATCH_ROOT/$USER/hf_cache"
mkdir -p "$HF_HOME"

# --- 4. Navigate to correct directory ---
cd "$REPO_ROOT/llm_experiments" || exit 1

# --- 5. Run Script ---
echo "Starting EE-PS Benchmark Batch ${BATCH_IDX}..."

python run_ee_math.py \
  --batch_idx="${BATCH_IDX}" \
  --mcmc_steps=10 \
  --temperature=0.25 \
  --seed="${SEED}" \
  --model="Qwen/Qwen2.5-Math-1.5B" \
  --layer_idx=18 \
  --save_str="results_ee"

echo ">>> JOB COMPLETE <<<"
